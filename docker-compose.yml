version: '3.7'

services:

  watchtower:
    container_name: watchtower
    image: index.docker.io/containrrr/watchtower:latest
    volumes:
      - '/var/run/docker.sock:/var/run/docker.sock'
      - '~/.docker/config.json:/config.json'
    restart: unless-stopped
    environment: 
      - WATCHTOWER_NOTIFICATIONS=slack
      - 'WATCHTOWER_NOTIFICATION_SLACK_HOOK_URL=https://hooks.slack.com/services/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'
      - WATCHTOWER_NOTIFICATION_SLACK_IDENTIFIER=Docker_Watchtower
      - 'WATCHTOWER_NOTIFICATION_SLACK_CHANNEL=#updates'
      - WATCHTOWER_INCLUDE_STOPPED=true
      - WATCHTOWER_REVIVE_STOPPED=true
      - WATCHTOWER_POLL_INTERVAL=60
  
  certbot:
    image: certbot/certbot
    container_name: certbot
    volumes:
      - certbot-etc:/etc/letsencrypt
      - certbot-var:/var/lib/letsencrypt
      - web-root:/var/www/html
    depends_on:
      - clientprod
    command: certonly --webroot --webroot-path=/var/www/html --email v.gujarathi777@gmail.com --agree-tos --no-eff-email --force-renewal -d videoparty.tk  -d www.videoparty.tk

  clientsit:
    # container_name: video-party-client
    # build:
    #   context: .
    #   dockerfile: Dockerfile
    container_name: clientsit
    image: index.docker.io/varungujarathi9/video-party-client:sit
    restart: unless-stopped
    ports:
      - 3001:3000
    
  clientuat:
    # container_name: video-party-client
    # build:
    #   context: .
    #   dockerfile: Dockerfile
    container_name: clientuat
    image: index.docker.io/varungujarathi9/video-party-client:uat
    restart: unless-stopped
    ports:
      - 3002:80

  clientprod:
    # container_name: video-party-client
    # build:
    #   context: .
    #   dockerfile: Dockerfile
    container_name: clientprod
    image: index.docker.io/varungujarathi9/video-party-client:latest
    volumes:
      - web-root:/var/www/html
      - ./nginx-conf:/etc/nginx/conf.d
      - certbot-etc:/etc/letsencrypt
      - certbot-var:/var/lib/letsencrypt
      - dhparam:/etc/ssl/certs
    ports:
      - 80:80
      - 443:443 

  serversit:
    # container_name: video-party-server
    # build:
    #   context: .
    #   dockerfile: Dockerfile
    container_name: serversit
    image: index.docker.io/varungujarathi9/video-party-server:sit
    restart: unless-stopped
    ports:
      - 5001:5000

  serveruat:
    # container_name: video-party-server
    # build:
    #   context: .
    #   dockerfile: Dockerfile
    container_name: serveruat
    image: index.docker.io/varungujarathi9/video-party-server:uat
    restart: unless-stopped
    ports:
      - 5002:5000

  serverprod:
    # container_name: video-party-client
    # build:
    #   context: .
    #   dockerfile: Dockerfile
    container_name: serverprod
    image: index.docker.io/varungujarathi9/video-party-server:latest
    restart: unless-stopped
    ports:
      - 1793:5000

volumes:
  certbot-etc:
  certbot-var:
  web-root:
  dhparam:
    driver: local
    driver_opts:
      type: none
      device: /home/varungujarathi9/Local-Video-Party-Client/client/dhparam/
      o: bind   